/*
 CSS Class Applier module for Rangy.
 Adds, removes and toggles CSS classes on Ranges and Selections

 Part of Rangy, a cross-browser JavaScript range and selection library
 http://code.google.com/p/rangy/

 Depends on Rangy core.

 Copyright 2011, Tim Down
 Licensed under the MIT license.
 Version: 1.0.1
 Build date: 3 January 2011
*/
rangy.createModule("CssClassApplier",function(g){function n(a,b){return a.className&&RegExp("(^|\\s)"+b+"(\\s|$)").test(a.className)}function t(a,b){if(a.className)n(a,b)||(a.className+=" "+b);else a.className=b}function o(a){return a.className.split(/\s+/).sort().join(" ")}function k(a){var b;if(b=a.nodeType==1){if(b=a.tagName.toLowerCase()==h)a:{b=B;if(a.className){a=a.className.split(/\s+/);for(var c=a.length;c--;)if(b.test(a[c])){b=true;break a}}b=false}b=b}return b}function u(a){var b=i.getDocument(a),
c=a.parentNode,d=a.previousSibling,e=a.nextSibling,f;if(e){f=b.createElement(h);f.className=c.className;for(e=e;e;e=a.nextSibling)f.appendChild(e);i.insertAfter(f,c)}if(d){f=b.createElement(h);f.className=c.className;f.appendChild(a);i.insertAfter(f,c)}}function v(a,b){var c=a.nodeType==3,d=c?a.parentNode:a,e=b?"nextSibling":"previousSibling";if(k(d)){if((c=d[e])&&k(c)&&o(d)==o(c))return c[b?"firstChild":"lastChild"]}else if(c)if((c=a[e])&&c.nodeType==3)return c;return null}function p(a){this.firstTextNode=
(this.isElementMerge=a.nodeType==1)?a.lastChild:a;if(this.isElementMerge)this.sortedCssClasses=o(a);this.textNodes=[this.firstTextNode]}function m(a,b){this.cssClass=a;this.normalize=b;this.uniqueCssClass="rangy_"+ ++C;w=true}g.requireModules(["WrappedSelection","WrappedRange"]);var i=g.dom,h="span",q=function(){function a(b,c,d){return c&&d?" ":""}return function(b,c){if(b.className)b.className=b.className.replace(RegExp("(^|\\s)"+c+"(\\s|$)"),a)}}(),B=/rangy_[\d]+/,C=0;p.prototype={doMerge:function(){for(var a=
[],b,c,d=0,e=this.textNodes.length;d<e;++d){b=this.textNodes[d];c=b.parentNode;a[d]=b.data;if(d){c.removeChild(b);c.hasChildNodes()||c.parentNode.removeChild(c)}}return this.firstTextNode.data=a=a.join("")},getLength:function(){for(var a=this.textNodes.length,b=0;a--;)b+=this.textNodes[a].length;return b},toString:function(){for(var a=[],b=0,c=this.textNodes.length;b<c;++b)a[b]="'"+this.textNodes[b].data+"'";return"[Merge("+a.join(",")+")]"}};var w=false;m.setTagName=function(a){if(w)throw Error("Too late to set tag name: CssClassAppliers already exist");
else h=a};m.prototype={isAppliedToTextNode:function(a){a=a.parentNode;return a.tagName.toLowerCase()==h&&n(a,this.uniqueCssClass)},preApply:function(a){if(a.length){var b=a[0];a=a[a.length-1];var c=b.parentNode,d=a.parentNode;k(c)&&c.childNodes.length>1&&u(b);k(d)&&d.childNodes.length>1&&u(a)}},postApply:function(a,b){for(var c=a[0],d=a[a.length-1],e=[],f,r=c,x=d,y=0,z=d.length,l,A,j=0,s=a.length;j<s;++j){l=a[j];if(A=v(l,false)){if(!f){f=new p(A);e.push(f)}f.textNodes.push(l);if(l===c){r=f.firstTextNode;
y=r.length}if(l===d){x=f.firstTextNode;z=f.getLength()}}else f=null}if(c=v(d,true)){if(!f){f=new p(d);e.push(f)}f.textNodes.push(c)}if(e.length){j=0;for(s=e.length;j<s;++j)e[j].doMerge();b.setStart(r,y);b.setEnd(x,z)}},createContainer:function(a){a=a.createElement(h);a.className=this.cssClass+" "+this.uniqueCssClass;return a},applyToTextNode:function(a){var b=a.parentNode;if(k(b)&&b.childNodes.length==1){t(b,this.cssClass);t(b,this.uniqueCssClass)}else{b=this.createContainer(i.getDocument(a));a.parentNode.insertBefore(b,
a);b.appendChild(a)}},undoToTextNode:function(a){var b=a.parentNode,c=a.nextSibling,d=a.previousSibling,e=b.parentNode;if(c&&d){d=this.createContainer(i.getDocument(a));d.appendChild(c);i.insertAfter(d,b);d.parentNode.insertBefore(a,d)}else if(c)e.insertBefore(a,b);else if(d)i.insertAfter(a,b);else{q(b,this.cssClass);q(b,this.uniqueCssClass);if(!k(b)){e.insertBefore(a,b);e.removeChild(b)}}},applyToRange:function(a){a.splitBoundaries();var b=a.getNodes([3]);if(b.length){this.normalize&&this.preApply(b,
a);for(var c,d=0,e=b.length;d<e;++d){c=b[d];this.isAppliedToTextNode(c)||this.applyToTextNode(c)}a.setStart(b[0],0);c=b[b.length-1];a.setEnd(c,c.length);this.normalize&&this.postApply(b,a)}},applyToSelection:function(a){a=a||window;a=g.getSelection(a);var b,c=a.getAllRanges();a.removeAllRanges();for(var d=c.length;d--;){b=c[d];this.applyToRange(b);a.addRange(b)}},undoToRange:function(a){a.splitBoundaries();var b=a.getNodes([3]),c;if(b.length){this.normalize&&this.preApply(b,a);for(var d=0,e=b.length;d<
e;++d){c=b[d];this.isAppliedToTextNode(c)&&this.undoToTextNode(c)}a.setStart(b[0],0);c=b[b.length-1];a.setEnd(c,c.length);this.normalize&&this.postApply(b,a)}},undoToSelection:function(a){a=a||window;a=g.getSelection(a);var b=a.getAllRanges(),c;a.removeAllRanges();for(var d=0,e=b.length;d<e;++d){c=b[d];this.undoToRange(c);a.addRange(c)}},isAppliedToRange:function(a){a.splitBoundaries();a=a.getNodes([3]);for(var b=0,c=a.length;b<c;++b)if(!this.isAppliedToTextNode(a[b]))return false;return true},isAppliedToSelection:function(a){a=
a||window;a=g.getSelection(a).getAllRanges();for(var b=a.length;b--;)if(!this.isAppliedToRange(a[b]))return false;return true},toggleRange:function(a){this.isAppliedToRange(a)?this.undoToRange(a):this.applyToRange(a)},toggleSelection:function(a){this.isAppliedToSelection(a)?this.undoToSelection(a):this.applyToSelection(a)},removeUniqueClass:function(a){a=a||document;a=a.getElementsByTagName(h);for(var b=a.length,c=[];b--;)n(a[b],this.uniqueCssClass)&&c.push(a[b]);for(b=c.length;b--;)q(c[b],this.uniqueCssClass)},
detach:function(a){this.removeUniqueClass(a)}};g.CssClassApplier=m;g.createCssClassApplier=function(a,b){return new m(a,b)}});